<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Pay with Flow</title>
    <script src="https://checkout-web-components.checkout.com/index.js"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
      }
      .methods {
        margin-bottom: 20px;
      }
      .method-option {
        margin-bottom: 10px;
      }
      #flow-container {
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <h1>Choose payment method</h1>
    <div class="methods">
      <label class="method-option">
        <input type="radio" name="payment-method" value="card" />
        Card
      </label>
      <label class="method-option">
        <input type="radio" name="payment-method" value="googlepay" />
        googlepay
      </label>
    </div>

    <div id="flow-container"></div>
    <!-- <button id="pay-button" type="button" disabled>Pay</button> -->

    <script>
      (async () => {
        const amount = 10000;
        let amountOverride;
        let selectedMethod = null;
        let component = null;
        let checkout;

        // const payButton = document.getElementById("pay-button");
        const flowContainer = document.getElementById("flow-container");

        const createPaymentSession = async () => {
          const res = await fetch(
            "https://api.sandbox.checkout.com/payment-sessions",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer sk_sbox_odyoauybjpcfbkzmgsnnbiub4mj",
              },
              body: JSON.stringify({
                amount,
                currency: "EUR",
                billing: {
                  address: {
                    country: "NL",
                  },
                },
                success_url: "https://example.com/success",
                failure_url: "https://example.com/failure",
                processing_channel_id: "pc_w2njpb6jbjjujgcz5dgzxdn5mm",
              }),
            }
          );
          return res.json();
        };

        const paymentSession = await createPaymentSession(); // ✅ Called once

        const initFlow = async (method) => {
          // Clear previous component
          console.log("Old Component", component);

          if (component) {
            component.unmount();
          }

          console.log(paymentSession);

          checkout = await CheckoutWebComponents({
            // ✅ Initialized once
            publicKey: "pk_sbox_guri7tp655hvceb3qaglozm7gee",
            paymentSession,
            onError: (_, error) => console.error(error),
            // showPayButton: false,
            environment: "sandbox",
          });

          component = checkout.create(method);

          console.log("New Component", component);

          if (await component.isAvailable()) {
            console.log("Available✅");

            component.mount(flowContainer);
            // payButton.disabled = false;
          } else {
            console.log("Not Available❌");

            // payButton.disabled = true;
            alert(`${method} is not available`);
          }
        };

        document
          .querySelectorAll('input[name="payment-method"]')
          .forEach((input) => {
            input.addEventListener("change", async (e) => {
              selectedMethod = e.target.value;
              // payButton.disabled = true;
              await initFlow(selectedMethod);
            });
          });

        // payButton.addEventListener("click", () => {
        //   if (component) component.submit();
        // });
      })();
    </script>
  </body>
</html>
